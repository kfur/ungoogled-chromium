# Development notes and procedures

The [GitHub Wiki](//github.com/Eloston/ungoogled-chromium/wiki) contains some additional information that changes more frequently.

## Workflow of updating patches

Tested on Debian 9.0 (stretch). Exact instructions should work on any other Linux or macOS system with the proper dependencies.

It is recommended to read the [BUILDING.md](BUILDING.md) and [DESIGN.md](DESIGN.md) documents first to gain a deeper understanding of the process.

### Dependencies

* [`quilt`](http://savannah.nongnu.org/projects/quilt)
    * This is available in most (if not all) Linux distributions, and also Homebrew on macOS.
    * This utility facilitates most of the updating process, so it is important to learn how to use this. The manpage for quilt (as of early 2017) lacks an example of a workflow. There are multiple guides online, but [this guide from Debian](https://wiki.debian.org/UsingQuilt) and [the referenced guide on that page](https://raphaelhertzog.com/2012/08/08/how-to-use-quilt-to-manage-patches-in-debian-packages/) are the ones referenced in developing the current workflow.
* Python 3.5 or newer

#### Steps for initial update

This is an example workflow on Linux that can be modified for your specific usage.

### Downloading the source code and updating lists

1. Download and extract the Chromium source tree into a sandbox directory. Do not apply source cleaning during this step if updating the source cleaning list.
    * Source cleaning can be ignored by passing in an empty source cleaning list. See the example below.
2. Update source cleaning and domain substitution lists
    1. Generate new cleaning list
    2. Run source cleaning. This ensures that the generation of the domain substitution list won't include cleaned files.
    3. Generate new domain substitution list. **IMPORTANT**: Do not apply domain substitution until initial patch updating has completed. This will create a dependency on domain substitution.

Here's an example for updating the `common` configuration type:

```
export UTILIKIT_CONFIG_TYPE=common
printf "" | ./utilikit/prepare_sources.py --source-cleaning-list -
./developer_utilities/update_lists.py --generate cleaning_list --cleaning-list resources/configs/common/cleaning_list --sandbox-dir build/sandbox
./utilikit/clean_sources.py # This is important so domain substitution does not include extra files
./developer_utilities/update_lists.py --generate domain_substitution_list --domain-regex-list resources/configs/common/domain_regex_list --domain-substitution-list resources/configs/common/domain_substitution_list --sandbox-dir build/sandbox
```

#### Updating patches

**IMPORTANT**: Make sure domain substitution has not been applied before continuing. Otherwise, the resulting patches will require domain substitution.

1. Generate the patch order for the desired configuration to modify via `developer_utilities/generate_patch_order.py`
    * Pass in `--help` for arguments it takes
    * Choose the appropriate configuration that contains the patches to be updated. To get just the common patches, use the `common` config.
2. Run `source $ROOT/developer_utilities/set_quilt_vars.sh $ROOT`, where `$ROOT` is the ungoogled-chromium directory.
    * This will setup quilt to modify patches directly in `resources/`
3. Use `quilt` to update the patches. The general procedure is as follows:
    1. Make sure all patches are unapplied: `quilt pop -a`. Check the status with `quilt top`
    2. Execute shell loop: `while quilt push; do quilt refresh -p ab --no-index --no-timestamp; done`
    3. If an error occurs, do `quilt push -f`
    4. Edit the broken files as necessary, adding (`quilt add ...`) or removing (`quilt remove ...`) files as necessary
    5. `quilt refresh -p ab`
    6. Go back and continue from Step 2, repeating until all of the patches have been fixed
    8. Remove backup patch files (ending in `.patch~`) generated by `quilt` as necessary: `find resources/patches -name "*.patch~" | xargs rm`

This should leave unstaged changes in the git repository to be reviewed, added, and committed.

If you used `quilt new` anywhere during the update process, remember to add that patch manually to the corresponding `patch_order` in `resources/configs`.

### Steps for revisions after a build attempt

If domain substitution is not used, then the above setup will still work for performing updates to the patches between build attempts.

If domain substitution is being used, then the steps for the initial update will not apply since that would create patches which depend on domain substitution (which is undesirable for use cases that don't use domain substitution). Here is a method of dealing with this:

1. Use quilt to update the domain-substituted copy of the patch set
2. Copy back modified patches to the repository after reverting domain substitution on the patches manually
3. Attempt a build
4. Repeat steps as necessary
